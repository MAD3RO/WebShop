@model IEnumerable<WebShop.Models.ViewModels.Cart.CartVM>

@{
    ViewBag.Title = "Cart Details";
    int count = 1;
}

<!-- SECTION -->
<div class="section" id="body-section">
    <!-- container -->
    <div class="container">
        <h2 class="page-header">Cart Details</h2>

        @if (ViewBag.Message != null)
        {
            <h4 class="text-center">@ViewBag.Message</h4>
        }
        else
        {
            <table id="cart" class="table table-hover table-condensed">
                <thead>
                    <tr>
                        <th style="width:60%">Product</th>
                        <th style="width:8%" class="text-center">Price</th>
                        <th style="width:7%" class="text-center">Quantity</th>
                        <th style="width:10%" class="text-center">Subtotal</th>
                        <th style="width:15%"></th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in Model)
                    {
                        <tr>

                            <td data-th="Product">
                                <div class="row">
                                    <div class="col-sm-3 hidden-xs">
                                        <a href="/shop/product-details/@item.Slug">
                                            <img src="/Images/Uploads/Products/@item.ProductId/Thumbs/@item.Image" class="img-responsive" />
                                        </a>
                                    </div>
                                    <div class="col-sm-9">
                                        <a href="/shop/product-details/@item.Slug">
                                            <h4 class="nomargin">@item.ProductName</h4>
                                        </a>
                                        <p>@item.Description</p>
                                    </div>
                                </div>
                            </td>
                            <td class="text-center" data-th="Price">$@item.Price</td>
                            <td class="text-center qty@(item.ProductId)" data-th="Quantity">
                                @*<input type="number" class="form-control text-center" value="1">*@
                                @item.Quantity
                            </td>
                            <td class="text-center total@(item.ProductId)" data-th="Subtotal">$@item.Total</td>
                            <td class="actions text-center" data-th="">
                                @*<button class="btn btn-danger btn-sm"><i class="fa fa-trash-o"></i></button>*@
                                <a href="#" class="incrproduct" data-id="@item.ProductId"><span class="qty-up">+</span></a>
                                <a href="#" class="decrproduct" data-id="@item.ProductId"><span class="qty-down">-</span></a>
                                <a href="#" class="removeproduct btn btn-danger btn-sm" data-id="@item.ProductId"><i class="fas fa-trash"></i> Remove</a>
                            </td>
                        </tr>
                    }
                </tbody>
                <tfoot>
                    <tr class="visible-xs">
                        <td class="text-center"><strong>$<span>@ViewBag.GrandTotal</span></strong></td>
                    </tr>
                    <tr>
                        <td><a href="javascript:history.back()" class="btn back"><i class="fa fa-arrow-circle-left"></i> Continue Shopping</a></td>
                        <td colspan="2" class="hidden-xs"></td>
                        <td class="grandtotal hidden-xs text-center"><strong>$<span>@ViewBag.GrandTotal</span></strong></td>
                        <td><a href="#" class="btn placeorder">Checkout <i class="fa fa-arrow-circle-right"></i></a></td>
                    </tr>
                </tfoot>
            </table>

            <div class="paypaldiv">
                <form class="paypalform" action="https://www.sandbox.paypal.com/cgi-bin/webscr" method="post">
                    <input type="hidden" name="cmd" value="_cart">
                    <input type="hidden" name="upload" value="1">
                    <input type="hidden" name="business" value="tylerdurden_seller@gmail.com">

                    @foreach (var item in Model)
                    {
                        <input type="hidden" name="item_name_@count" value="@item.ProductName">
                        <input type="hidden" name="amount_@count" value="@item.Price">
                        <input type="hidden" name="quantity_@count" value="@item.Quantity">
                        count++;

                    }
                    <input type="hidden" name="currency_code" value="USD">
                    <input type="image" src="http://www.paypal.com/en_US/i/btn/x-click-but01.gif" name="submit" alt="Make payments with PayPal - it's fast, free and secure!">
                </form>
            </div>
        }
    </div>
</div>

@section Scripts{
    <script>

        $(function () {
            /*
             * Increment product
             */

            $("a.incrproduct").click(function (e) {
                e.preventDefault();

                var productId = $(this).data("id");
                var url = "/cart/IncrementProduct";

                $.getJSON(url, { productId: productId }, function (data) {

                    $("td.qty" + productId).html(data.qty);

                    var price = data.qty * data.price;
                    var priceHtml = "$" + price.toFixed(2);

                    $("td.total" + productId).html(priceHtml);

                    var gt = parseFloat($("td.grandtotal span").text());
                    var grandtotal = (gt + data.price).toFixed(2);

                    $("td.grandtotal span").text(grandtotal);
                }).done(function (data) {
                    var url2 = "/cart/PaypalPartial";

                    $.get(url2, {}, function (data) {
                        $('div.paypaldiv').html(data);
                    });
                });
            });
            /////////////////////////////////////////////////////////////

            /*
            * Decrement product
            */

            $("a.decrproduct").click(function (e) {
                e.preventDefault();

                var $this = $(this);
                var productId = $(this).data("id");
                var url = "/cart/DecrementProduct";

                $.getJSON(url, { productId: productId }, function (data) {
                    if (data.qty == 0) {
                        $this.parent().parent().fadeOut("fast", function () {
                            location.reload();
                        });
                    }
                    else {
                        $("td.qty" + productId).html(data.qty);

                        var price = data.qty * data.price;
                        var priceHtml = "$" + price.toFixed(2);

                        $("td.total" + productId).html(priceHtml);

                        var gt = parseFloat($("td.grandtotal span").text());
                        var grandtotal = (gt - data.price).toFixed(2);

                        $("td.grandtotal span").text(grandtotal);
                    }

                }).done(function (data) {
                    var url2 = "/cart/PaypalPartial";

                    $.get(url2, {}, function (data) {
                        $('div.paypaldiv').html(data);
                    });
                });
            });

            //////////////////////////////////////////////////////////////

            /*
            * Remove product
            */

            $("a.removeproduct").click(function (e) {
                e.preventDefault();

                var $this = $(this);
                var productId = $(this).data("id");
                var url = "/cart/RemoveProduct";

                $.get(url, { productId: productId }, function (data) {
                    location.reload();
                });
            });

            //////////////////////////////////////////////////////////////

            /*
            * Place order
            */

            $("a.placeorder").click(function (e) {
                e.preventDefault();

                var $this = $(this);
                var url = "/cart/PlaceOrder";
                $(".ajaxbg").show();

                $.post(url, {}, function (data) {
                    $(".ajaxbg span").text("Thank you. You will now be redirected to paypal.");
                    setTimeout(function () {
                        $('form input[name="submit"]').click();
                    }, 2000);
                });
            });

            //////////////////////////////////////////////////////////////

        });
    </script>
}
